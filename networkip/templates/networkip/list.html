{% extends "base.html" %}

{% block title %}Netzwerk-Scanner{% endblock %}

{% block content %}
<h1>Netzwerk- & Sicherheits-Scanner</h1>

<div class="row">
  <!-- Home Network Section -->
  <div class="col-lg-6 mb-4">
    <div class="card border-primary">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Heimnetz (192.168.178.x)</h5>
      </div>
      <div class="card-body">
        <button id="scan-home-btn" class="btn btn-primary mb-3">Scan starten</button>
        <div id="home-status" class="mb-3" aria-live="polite"></div>
        <div class="table-responsive">
          <table class="table table-sm table-striped">
            <thead>
              <tr>
                <th>IP</th>
                <th>Hostname</th>
              </tr>
            </thead>
            <tbody id="home-results-body">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- VM Network Section -->
  <div class="col-lg-6 mb-4">
    <div class="card border-warning">
      <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">VMs (192.168.122.x)</h5>
      </div>
      <div class="card-body">
        <button id="scan-vm-btn" class="btn btn-warning mb-3">Scan starten</button>
        <div id="vm-status" class="mb-3" aria-live="polite"></div>
        <div class="table-responsive">
          <table class="table table-sm table-striped">
            <thead>
              <tr>
                <th>IP</th>
                <th>Hostname</th>
              </tr>
            </thead>
            <tbody id="vm-results-body">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Internet Security Section -->
<div class="row mt-4">
  <div class="col-lg-12 mb-4">
    <div class="card border-danger">
      <div class="card-header bg-danger text-white">
        <h5 class="mb-0">Internet-Sicherheits-Scanner</h5>
      </div>
      <div class="card-body">
        <div class="input-group mb-3">
          <input id="internet-url" type="text" class="form-control" placeholder="z.B. example.com oder https://example.com" />
          <button id="scan-internet-btn" class="btn btn-danger">Scan starten</button>
        </div>
        <div id="internet-status" class="mb-3" aria-live="polite"></div>
        <div id="internet-vulnerabilities" class="mb-3"></div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  function showStatus(statusEl, text, busy=false){
    statusEl.innerHTML = '';
    const el = document.createElement('div');
    el.className = busy ? 'alert alert-info' : 'alert alert-secondary';
    el.textContent = text;
    statusEl.appendChild(el);
  }

  function renderResults(resultsBody, items){
    resultsBody.innerHTML = '';
    if(!items || items.length === 0){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 2;
      td.textContent = 'Keine Geräte gefunden';
      tr.appendChild(td);
      resultsBody.appendChild(tr);
      return;
    }

    items.forEach(r => {
      const tr = document.createElement('tr');
      const ipTd = document.createElement('td');
      ipTd.textContent = r.ip;
      const hostTd = document.createElement('td');
      hostTd.textContent = r.hostname || '-';
      tr.appendChild(ipTd);
      tr.appendChild(hostTd);
      resultsBody.appendChild(tr);
    });
  }

  async function runScan(endpoint, statusEl, resultsBody, buttonEl){
    buttonEl.disabled = true;
    showStatus(statusEl, 'Läuft 0/255', true);
    renderResults(resultsBody, []);

    try{
      const resp = await fetch(endpoint);
      if(!resp.ok) throw new Error('Netzwerkfehler');
      
      const reader = resp.body.getReader();
      const decoder = new TextDecoder();
      let results = [];

      while(true){
        const {done, value} = await reader.read();
        if(done) break;

        const text = decoder.decode(value, {stream: true});
        const lines = text.split('\n').filter(l => l.trim());

        for(const line of lines){
          try{
            const data = JSON.parse(line);
            if(data.done){
              // Final results
              renderResults(resultsBody, data.results || []);
              showStatus(statusEl, 'Scan fertig — ' + (data.results?.length || 0) + ' Gerät(e) gefunden.');
            }else if(data.progress){
              // Progress update
              showStatus(statusEl, `Läuft ${data.progress}/${data.total} (${data.alive_count} aktiv)`, true);
            }
          }catch(e){
            console.error('JSON parse error:', e);
          }
        }
      }
    }catch(err){
      showStatus(statusEl, 'Fehler beim Scan: ' + err.message);
    }finally{
      buttonEl.disabled = false;
    }
  }

  // Internet Security Scan
  async function runInternetScan(){
    const url = document.getElementById('internet-url').value.trim();
    if(!url){
      alert('Bitte URL eingeben');
      return;
    }

    const btn = document.getElementById('scan-internet-btn');
    const statusEl = document.getElementById('internet-status');
    const vulnEl = document.getElementById('internet-vulnerabilities');

    btn.disabled = true;
    showStatus(statusEl, 'Scan läuft...', true);
    vulnEl.innerHTML = '';

    try{
      const resp = await fetch('api/internet/?url=' + encodeURIComponent(url));
      if(!resp.ok) throw new Error('Netzwerkfehler');
      
      const reader = resp.body.getReader();
      const decoder = new TextDecoder();
      let vulnerabilities = [];

      while(true){
        const {done, value} = await reader.read();
        if(done) break;

        const text = decoder.decode(value, {stream: true});
        const lines = text.split('\n').filter(l => l.trim());

        for(const line of lines){
          try{
            const data = JSON.parse(line);
            if(data.error){
              showStatus(statusEl, 'Fehler: ' + data.error);
            }else if(data.done){
              vulnerabilities = data.vulnerabilities || [];
              showStatus(statusEl, 'Scan fertig — ' + vulnerabilities.length + ' Sicherheitsproblem(e) gefunden.');
              renderVulnerabilities(vulnEl, vulnerabilities);
            }else if(data.in_progress){
              showStatus(statusEl, `${data.description} (${data.vulnerability_count} gefunden)`, true);
            }
          }catch(e){
            console.error('JSON parse error:', e);
          }
        }
      }
    }catch(err){
      showStatus(statusEl, 'Fehler beim Scan: ' + err.message);
    }finally{
      btn.disabled = false;
    }
  }

  function renderVulnerabilities(container, vulns){
    container.innerHTML = '';
    if(!vulns || vulns.length === 0){
      const alert = document.createElement('div');
      alert.className = 'alert alert-success';
      alert.textContent = '✓ Keine bekannten Sicherheitsprobleme gefunden!';
      container.appendChild(alert);
      return;
    }

    vulns.forEach(vuln => {
      const card = document.createElement('div');
      card.className = 'alert alert-warning mb-2';
      card.innerHTML = `
        <strong>${vuln.type}</strong><br/>
        ${vuln.description}
      `;
      container.appendChild(card);
    });
  }

  // Home network
  const homeBtn = document.getElementById('scan-home-btn');
  const homeStatus = document.getElementById('home-status');
  const homeResults = document.getElementById('home-results-body');
  homeBtn.addEventListener('click', () => runScan('api/home/stream/', homeStatus, homeResults, homeBtn));

  // VM network
  const vmBtn = document.getElementById('scan-vm-btn');
  const vmStatus = document.getElementById('vm-status');
  const vmResults = document.getElementById('vm-results-body');
  vmBtn.addEventListener('click', () => runScan('api/vm/stream/', vmStatus, vmResults, vmBtn));

  // Internet scanner
  const internetBtn = document.getElementById('scan-internet-btn');
  internetBtn.addEventListener('click', runInternetScan);

  // Allow Enter key to start internet scan
  document.getElementById('internet-url').addEventListener('keypress', (e) => {
    if(e.key === 'Enter') runInternetScan();
  });
});
</script>
{% endblock %}
