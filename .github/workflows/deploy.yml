name: Manueller Check & Merge zu Main

on:
  workflow_dispatch: # Ermöglicht den manuellen Start per Button in GitHub

jobs:
  check-and-sync:
    runs-on: ubuntu-latest
    # Berechtigungen zum Schreiben in das Repository (für den Merge)
    permissions:
      contents: write

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0 # Wichtig, um alle Branches für den Merge zu laden

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install django

    - name: Run Django Checks
      run: |
        python manage.py check

    # Dieser Schritt synchronisiert die aktuelle Branch mit main, wenn alles ok ist
    - name: Merge aktuelle Branch in Main
      if: success()
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        
        # Aktuelle Branch merken
        CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
        echo "Synchronisiere $CURRENT_BRANCH mit main..."
        
        # Zu main wechseln, mergen und pushen
        git checkout main
        git merge $CURRENT_BRANCH --no-ff -m "Auto-Merge nach erfolgreichem Check"
        git push origin main
        
        # Wieder zurück zur ursprünglichen Branch (damit diese erhalten bleibt)
        git checkout $CURRENT_BRANCH
